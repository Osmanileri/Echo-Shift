opt_out_usage

default_platform(:ios)

platform :ios do
  desc "Push a new build to TestFlight"
  lane :deploy do
    bundle_id = "com.osmanileri.echoshift"
    team_id = ENV["APPLE_TEAM_ID"]

    # 0. Gecici Keychain Olustur
    keychain_name = "ci_keychain"
    keychain_password = "ci_password"
    
    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    # Keychain yolunu context'ten al (Mutlaka absolute path olmali)
    # create_keychain bunu kendisi context'e yazar.
    current_keychain_path = Actions.lane_context[SharedValues::KEYCHAIN_PATH]

    # 1. API Key Auth
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      duration: 1200,
      in_house: false
    )

    # 2. Proje Ayarlari
    disable_automatic_code_signing(path: "ios/App/App.xcodeproj")
    
    update_project_team(path: "ios/App/App.xcodeproj", teamid: team_id)
    update_app_identifier(xcodeproj: "ios/App/App.xcodeproj", plist_path: "App/Info.plist", app_identifier: bundle_id)
    increment_build_number(build_number: ENV["GITHUB_RUN_NUMBER"], xcodeproj: "ios/App/App.xcodeproj")

    # 3. Sertifika ve Profil
    cert(
      api_key: api_key, 
      development: false,
      force: false,
      keychain_path: current_keychain_path, # Artik tam yolu veriyoruz
      keychain_password: keychain_password
    )

    sigh(
      api_key: api_key,
      app_identifier: bundle_id,
      force: true,
      team_id: team_id,
      provisioning_name: "AppStore_#{bundle_id}" 
    )
    
    # 4. Build
    build_app(
      scheme: "App",
      project: "ios/App/App.xcodeproj",
      configuration: "Release",
      export_method: "app-store",
      include_bitcode: false,
      clean: true,
      export_options: {
        provisioningProfiles: { 
          bundle_id => Actions.lane_context[SharedValues::SIGH_NAME]
        }
      },
      export_team_id: team_id,
      # OTHER_CODE_SIGN_FLAGS icin de tam yolu kullaniyoruz ve tirnak icine aliyoruz
      xcargs: "DEVELOPMENT_TEAM=#{team_id} PROVISIONING_PROFILE_SPECIFIER='#{Actions.lane_context[SharedValues::SIGH_NAME]}' CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY='Apple Distribution' OTHER_CODE_SIGN_FLAGS='--keychain \"#{current_keychain_path}\"'"
    )

    # 5. Upload
    upload_to_testflight(api_key: api_key, app_identifier: bundle_id, skip_waiting_for_build_processing: true)
  end
end
