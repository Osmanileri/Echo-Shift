opt_out_usage

default_platform(:ios)

platform :ios do
  desc "Push a new build to TestFlight"
  lane :deploy do
    bundle_id = "com.osmanileri.echoshift"
    team_id = ENV["APPLE_TEAM_ID"]

    # ========================================
    # 0. GECICI KEYCHAIN OLUSTUR
    # ========================================
    # CI ortaminda codesign sifresi sorar ve takilir.
    # Gecici bir keychain olusturup sertifikayi oraya koyariz.
    keychain_name = "ci_keychain"
    keychain_password = "ci_password"
    
    # macOS keychain dosyalarina -db uzantisi ekler!
    # Dogru yol: /Users/runner/Library/Keychains/ci_keychain-db
    keychain_path = File.expand_path("~/Library/Keychains/#{keychain_name}-db")
    
    # Eger zaten varsa sil, yeniden olustur (temiz baslangic)
    delete_keychain(name: keychain_name) if File.exist?(keychain_path)
    
    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    # ========================================
    # 1. API KEY AUTH
    # ========================================
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      duration: 1200,
      in_house: false
    )

    # ========================================
    # 2. PROJE AYARLARI
    # ========================================
    # Otomatik imzalamayi kapat (Xcode kafasina gore sertifika aramasin)
    update_code_signing_settings(
      path: "ios/App/App.xcodeproj",
      use_automatic_signing: false,
      team_id: team_id,
      code_sign_identity: "Apple Distribution",
      profile_name: "AppStore_#{bundle_id}"
    )
    
    update_app_identifier(
      xcodeproj: "ios/App/App.xcodeproj", 
      plist_path: "App/Info.plist", 
      app_identifier: bundle_id
    )
    
    increment_build_number(
      build_number: ENV["GITHUB_RUN_NUMBER"], 
      xcodeproj: "ios/App/App.xcodeproj"
    )

    # ========================================
    # 3. SERTIFIKA VE PROFIL
    # ========================================
    # Sertifikayi indir ve gecici keychain'e yukle
    cert(
      api_key: api_key, 
      development: false,
      force: false,
      keychain_path: keychain_path,
      keychain_password: keychain_password
    )

    # Provisioning profile olustur/indir
    sigh(
      api_key: api_key,
      app_identifier: bundle_id,
      force: true,
      team_id: team_id,
      provisioning_name: "AppStore_#{bundle_id}" 
    )
    
    # Profilin gercek adini al (Fastlane sonuna sayi ekleyebilir)
    profile_name = Actions.lane_context[SharedValues::SIGH_NAME]

    # ========================================
    # 4. BUILD
    # ========================================
    build_app(
      scheme: "App",
      project: "ios/App/App.xcodeproj",
      configuration: "Release",
      export_method: "app-store",
      include_bitcode: false,
      clean: true,
      export_options: {
        provisioningProfiles: { 
          bundle_id => profile_name
        }
      },
      export_team_id: team_id,
      xcargs: "DEVELOPMENT_TEAM='#{team_id}' PROVISIONING_PROFILE_SPECIFIER='#{profile_name}' CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY='Apple Distribution' OTHER_CODE_SIGN_FLAGS='--keychain #{keychain_path}'"
    )

    # ========================================
    # 5. TESTFLIGHT'A YUKLE
    # ========================================
    upload_to_testflight(
      api_key: api_key, 
      app_identifier: bundle_id, 
      skip_waiting_for_build_processing: true
    )
  end
end
